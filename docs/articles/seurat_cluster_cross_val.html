<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial: cluster validation in Seurat using count splitting • countsplit.tutorials</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial: cluster validation in Seurat using count splitting">
<meta property="og:description" content="countsplit.tutorials">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">countsplit.tutorials</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/countsplit_tutorial.html">Differential expression tutorial</a>
</li>
<li>
  <a href="../articles/MSE_tutorial.html">Cross validation tutorial</a>
</li>
<li>
  <a href="../articles/seurat_tutorial.html">Seurat tutorial</a>
</li>
<li>
  <a href="../articles/scran_tutorial.html">Scran tutorial</a>
</li>
<li>
  <a href="../articles/monocle3_tutorial.html">Monocle3 tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial: cluster validation in Seurat using
count splitting</h1>
            
      
      
      <div class="hidden name"><code>seurat_cluster_cross_val.Rmd</code></div>

    </div>

    
    
<p><em>This document is a work in progress and is only meant for the
development version of the <code>countsplit.tutorials</code>
package.</em></p>
<div class="section level2">
<h2 id="goal-and-setup">Goal and setup<a class="anchor" aria-label="anchor" href="#goal-and-setup"></a>
</h2>
<p>In this tutorial, we show how Poisson and negative binomial count
splitting can be used to choose the resolution parameter when clustering
the <code>pbmc</code> data using Seurat. This tutorial also serves as
our introduction to using negative binomial count splitting on real
data, where overdispersion parameters must be estimated.</p>
<p>We start by loading the necessary packages and installing the
<code>pbmc</code> data. Note that this is the dataset used in the Seurat
<a href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html" class="external-link">clustering
tutorial</a>, but is also included in the
<code>countsplit.tutorials</code> package for convenience.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Packages </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/anna-neufeld/countsplit" class="external-link">countsplit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/satijalab/sctransform" class="external-link">sctransform</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load data and replace underscores with dashes in rownames (needed for Seurat)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">pbmc.counts</span>, package<span class="op">=</span><span class="st">"countsplit.tutorials"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"_"</span>, replacement <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>After preprocessing, the Seurat <a href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html" class="external-link">clustering
tutorial</a> applies Louvain clustering (as implemented in
<code><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">Seurat::FindClusters</a></code>) to identify cell types in the data.
The Louvain clustering algorithm has a resolution parameter that
determines the granularity of the clustering, with larger values leading
to greater numbers of clusterings. The Seurat tutorial suggests that
values between 0.4-1.2 typically return good results for single-cell
datasets of around 3,000 cells (the size of the <code>pbmc</code>)
dataset, but they note that this optimal value can increase for larger
datasets. In the tutorial itself, they use 0.5 as the resolution
parameter.</p>
<p>In this tutorial, our goal is to empirically determine the most
appropriate resolution parameter. We do this by (a) estimating clusters
using a range of resulolution parameters, and then (b) evaluating each
resulting clustering using some metric and picking the optimal
parameter. To motivate our approach, we will start by attempting to do
this <em>without</em> count splitting. We start by creating a Seurat
object using <code>pbmc.counts</code> and then applying the standard
normalization and preprocessing pipeline.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">pbmc.counts</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">pbmc</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pbmc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p>We now apply clustering for a range of resolution parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resRange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pbmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmc</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Each attempt at clustering creates a new column in the
<code>meta.data</code> slot of <code>pbmc</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pbmc</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span></span></code></pre></div>
<p>Thus, to acccess the resulting clusters we just need to store these
names.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"RNA_snn_res."</span>, <span class="va">resRange</span><span class="op">)</span></span></code></pre></div>
<p>For our evaluation metric, we will use a simple within-cluster sum of
squared errors function. This function simply iterates through the
estimated clusters. For each cluster, we compute the sum of squared
differences between each datapoint in the cluster and the cluster center
(the average expression over all of the cells).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">within.cluster.sse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">clusters.est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">totSS</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">lab</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">clusters.est</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">clusters.est</span><span class="op">==</span><span class="va">lab</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clustdat</span><span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="va">clusters.est</span><span class="op">==</span><span class="va">lab</span>,<span class="op">]</span></span>
<span>    <span class="va">cluster.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">clustdat</span><span class="op">)</span></span>
<span>    <span class="va">pred.means</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">cluster.mean</span>, ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cluster.mean</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">clustdat</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>    <span class="va">totSS</span> <span class="op">&lt;-</span> <span class="va">totSS</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">clustdat</span><span class="op">-</span><span class="va">pred.means</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">totSS</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we are ready to apply this function. However, note that we
estimated our clusters on the level of the log-normalized data. Thus, it
also makes the most sense to evaluate the clusters on the level of the
log-normalized data. The log-normalized data is stored in the
<code>data</code> layer of the <code>pbmc</code> object (as opposed to
the raw counts, which are stored in the <code>counts</code> layer). This
is the data that we will pass into our evaluation function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmc</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span><span class="va">results.naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmc</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results.naive</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat</span>, <span class="va">clusters.est</span><span class="op">)</span> </span>
<span><span class="op">}</span></span></code></pre></div>
<p>We are now ready to plot the loss function vs. the resulotuion
parameter. We first scale the results so that they lie within an
interpretable 0-1 scale.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results.naive.norm</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">results.naive</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">results.naive</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">results.naive</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">results.naive</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="cn">NULL</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resRange</span>, y<span class="op">=</span><span class="va">results.naive.norm</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Resolution parameter"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Normalized within-cluster SSE"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Naive method"</span><span class="op">)</span></span></code></pre></div>
<p>As we can see, when we use our entire dataset both to estimate our
clusters and evaluate our clusters, we find that our loss function
continues to decrease as we increase our resolution parameter. This is
the “double dipping” problem described in <a href="https://arxiv.org/abs/2307.12985" class="external-link">our paper</a>.</p>
<p>But we have a problem here. Since we estimated our clusters and
evaluated them using the same data, our curve keeps decreasing as we add
more clusters. We need a better way to do this, Our proposal is as
follows.</p>
</div>
<div class="section level2">
<h2 id="metrics-and-methods">Metrics and Methods<a class="anchor" aria-label="anchor" href="#metrics-and-methods"></a>
</h2>
<p>In this tutprial, we use count-splitting to provide data-driven
solutions for determining the best number of clusters. We consider three
main metrics for cluster-evaluation:</p>
<ol style="list-style-type: decimal">
<li>Mean squared error</li>
<li>Stability</li>
<li>Modularity</li>
</ol>
<p>In practice, the choice of metric is up to the scientist, and the
metrics will not always agree on the optimal resolution parameter. While
count splitting can help guide our choice of number of clusters, domain
knowledge is also important– the chosen clusters should be biologically
reasonable.</p>
<p>And we will consider so many different methods! 1. Poisson count
splitting - Epsilon = 0.5 or Epsilon = 0.9. - Both a single repetition
or multiple repeated splits. 2. Poisson multisplitting - Cross
validation! - Not as releevant for stability. 3. Negative binomial count
splitting 3. Negative binomial multifold.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nSplits</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fl">10</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="do-the-count-splitting">Do the count splitting<a class="anchor" aria-label="anchor" href="#do-the-count-splitting"></a>
</h2>
<p>This is a big chunk of code, but we will use all of these things
later.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## Countsplit function expects a cell-by-gene matrix, not a gene-by-cell matrix.</span></span>
<span><span class="co">## Let's just do this a single time here so that we don't get confused later. </span></span>
<span><span class="va">pbmc.counts.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Two equally sized Poisson splits </span></span>
<span><span class="va">poissonSplit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Two equally sized negative binomial splits </span></span>
<span><span class="va">overdisps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">overdisps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span></span>
<span><span class="co">## I think there is some randomness here due to random gene sampling. Should this get changed througoug the randomness?</span></span>
<span><span class="co">## Yes. But first v</span></span>
<span><span class="va">sctransform_fit</span> <span class="op">&lt;-</span> <span class="fu">sctransform</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/vst.html" class="external-link">vst</a></span><span class="op">(</span><span class="va">pbmc.counts</span>, verbosity<span class="op">=</span><span class="fl">0</span>, residual_type <span class="op">=</span> <span class="st">"none"</span>, min_cells <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">overdisps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">[</span>,<span class="st">"theta"</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">nbSplit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, overdisps<span class="op">=</span><span class="va">overdisps</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## A list of 50 random Poisson equal splits </span></span>
<span><span class="va">poissonManySplits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">poissonManySplits9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, epsilon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">nbManySplits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span>  <span class="va">overdisps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">overdisps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span></span>
<span>  <span class="va">sctransform_fit</span> <span class="op">&lt;-</span> <span class="fu">sctransform</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/vst.html" class="external-link">vst</a></span><span class="op">(</span><span class="va">pbmc.counts</span>, verbosity<span class="op">=</span><span class="fl">0</span>, residual_type <span class="op">=</span> <span class="st">"none"</span>, min_cells <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">overdisps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">[</span>,<span class="st">"theta"</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, overdisps<span class="op">=</span><span class="va">overdisps</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Poisson 10-fold</span></span>
<span><span class="va">poisson10fold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, folds<span class="op">=</span><span class="va">folds</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## NB 10-fold </span></span>
<span><span class="va">overdisps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">overdisps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span></span>
<span><span class="va">sctransform_fit</span> <span class="op">&lt;-</span> <span class="fu">sctransform</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/vst.html" class="external-link">vst</a></span><span class="op">(</span><span class="va">pbmc.counts</span>, verbosity<span class="op">=</span><span class="fl">0</span>, residual_type <span class="op">=</span> <span class="st">"none"</span>, min_cells <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">overdisps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">[</span>,<span class="st">"theta"</span><span class="op">]</span></span>
<span><span class="va">nb10folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, folds<span class="op">=</span><span class="fl">10</span>, overdisps<span class="op">=</span><span class="va">overdisps</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nbManySplits9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span></span>
<span>  <span class="va">overdisps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">overdisps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmc.counts</span><span class="op">)</span></span>
<span>  <span class="va">sctransform_fit</span> <span class="op">&lt;-</span> <span class="fu">sctransform</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sctransform/man/vst.html" class="external-link">vst</a></span><span class="op">(</span><span class="va">pbmc.counts</span>, verbosity<span class="op">=</span><span class="fl">0</span>, residual_type <span class="op">=</span> <span class="st">"none"</span>, min_cells <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">overdisps</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sctransform_fit</span><span class="op">$</span><span class="va">model_pars_fit</span><span class="op">[</span>,<span class="st">"theta"</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/countsplit/man/countsplit.html" class="external-link">countsplit</a></span><span class="op">(</span><span class="va">pbmc.counts.t</span>, overdisps<span class="op">=</span><span class="va">overdisps</span>, epsilon<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mean-squared-error">Mean Squared Error<a class="anchor" aria-label="anchor" href="#mean-squared-error"></a>
</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># It is crucial that the things that are passed in are on the SAME SCALE</span></span>
<span><span class="co"># Pass in as gene-by-cell please! this is just a mess lol. </span></span>
<span><span class="va">within.cluster.sse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### If you passed in gene-by-cell matrices, we will automatically take the transpose for you. </span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">clusters.est</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"It seems that you passed in matrices that were gene-by-cell."</span><span class="op">)</span></span>
<span>    <span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span></span>
<span>    <span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"It seems that you passed in matrices that were cell-by-gene."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">totSS</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">lab</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">clusters.est</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">clusters.est</span><span class="op">==</span><span class="va">lab</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">clustdat.train</span> <span class="op">&lt;-</span> <span class="va">dat.train</span><span class="op">[</span><span class="va">clusters.est</span><span class="op">==</span><span class="va">lab</span>,<span class="op">]</span></span>
<span>      <span class="va">clustdat.test</span> <span class="op">&lt;-</span> <span class="va">dat.test</span><span class="op">[</span><span class="va">clusters.est</span><span class="op">==</span><span class="va">lab</span>,<span class="op">]</span></span>
<span>      <span class="va">cluster.mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">clustdat.train</span><span class="op">)</span></span>
<span>      <span class="va">pred.means</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">cluster.mean</span>, ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cluster.mean</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">clustdat.train</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>      <span class="va">totSS</span> <span class="op">&lt;-</span> <span class="va">totSS</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">clustdat.test</span><span class="op">-</span><span class="va">pred.means</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">totSS</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="single-poisson-split">Single Poisson Split<a class="anchor" aria-label="anchor" href="#single-poisson-split"></a>
</h4>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonSplit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonSplit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># same genes and cells in the train set as in the test set</span></span>
<span><span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span><span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#run Seurat pipeline</span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define a range of resolutions</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate within-cluster sse for each resolution</span></span>
<span><span class="va">results.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="va">resRange</span>, sse<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results.poisson</span><span class="op">[</span><span class="va">k</span>,<span class="op">]</span><span class="op">$</span><span class="va">sse</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">results.poisson</span> <span class="op">&lt;-</span> <span class="va">results.poisson</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sse_norm <span class="op">=</span> <span class="op">(</span><span class="va">sse</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#plot results</span></span>
<span><span class="va">pPoissonOne</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">results.poisson</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resolution</span>, y <span class="op">=</span> <span class="va">sse_norm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Poisson; single fold"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="single-nb-split">Single NB Split<a class="anchor" aria-label="anchor" href="#single-nb-split"></a>
</h4>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbSplit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbSplit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># same genes and cells in the train set as in the test set</span></span>
<span><span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span><span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#run Seurat pipeline</span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define a range of resolutions</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate within-cluster sse for each resolution</span></span>
<span><span class="va">results.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>resolution<span class="op">=</span><span class="va">resRange</span>, sse<span class="op">=</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">eps.train</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">results.nb</span><span class="op">[</span><span class="va">k</span>,<span class="op">]</span><span class="op">$</span><span class="va">sse</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">results.nb</span> <span class="op">&lt;-</span> <span class="va">results.nb</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sse_norm <span class="op">=</span> <span class="op">(</span><span class="va">sse</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sse</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#plot results</span></span>
<span><span class="va">pnbOne</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">results.nb</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resolution</span>, y <span class="op">=</span> <span class="va">sse_norm</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"nb; single fold"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pPoissonone</span><span class="op">+</span><span class="va">pNBOne</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="many-poisson-splits">Many Poisson splits<a class="anchor" aria-label="anchor" href="#many-poisson-splits"></a>
</h4>
<p>We want to make sure our results were not only due to randomness of
the particular split.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">nSplits</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">trial</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonManySplits</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonManySplits</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># calculcate within-cluster sse for each resolution</span></span>
<span>  <span class="va">eps.train</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">all.results.poisson</span><span class="op">[</span><span class="va">trial</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">all.results.poisson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">all.results.poisson</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all.results.poisson</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span></span>
<span></span>
<span><span class="va">all.results.poisson</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span></span>
<span><span class="va">all.results.poisson2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">all.results.poisson</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">all.results.poisson.group</span> <span class="op">&lt;-</span> <span class="va">all.results.poisson2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pPoissonRepeated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all.results.poisson.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Poisson; many repeated splits"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="poisson-multifold">Poisson multifold<a class="anchor" aria-label="anchor" href="#poisson-multifold"></a>
</h4>
<p>For this one, the training set and the test set are apples and
oranges! We need to make sure that we address this through scaling.</p>
<p>GO THROUGH A LITTLE SCALING demonstration, then suggest that people
use a faster version in the future.</p>
<p>WAIT lol if you do size facts correctly do you actually need to
scale?</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multifold.results.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">folds</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">fold</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">folds</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtest</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poisson10fold</span><span class="op">[[</span><span class="va">fold</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="va">pbmc.counts</span> <span class="op">-</span> <span class="va">Xtest</span></span>
<span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  </span>
<span>  <span class="va">dat.train</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  <span class="co">#raw.counts.train &lt;- GetAssayData(pbmcTrain, layer="counts")</span></span>
<span>  <span class="co">#scale.factor &lt;- 10000</span></span>
<span>  <span class="co">#sizeFacs.train &lt;- pbmcTrain$nCount_RNA</span></span>
<span>  <span class="co">#dat.train &lt;- sapply(1:NCOL(raw.counts.train), function(u) log1p(raw.counts.train[,u]/sizeFacs.train[u]* scale.factor))</span></span>
<span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span>  </span>
<span>    <span class="va">dat.test</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span>  </span>
<span>  <span class="co">#raw.counts.test &lt;- GetAssayData(pbmcTest, layer="counts")</span></span>
<span>  <span class="co">#sizeFacs.test &lt;- pbmcTest$nCount_RNA</span></span>
<span>  <span class="co">#dat.test &lt;- sapply(1:NCOL(raw.counts.test), function(u) log1p(raw.counts.test[,u]/sizeFacs.test[u]*scale.factor))</span></span>
<span>  </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">multifold.results.poisson</span><span class="op">[</span><span class="va">fold</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multifold.results.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">multifold.results.poisson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">multifold.results.poisson</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">multifold.results.poisson</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span><span class="va">multifold.results.poisson</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">folds</span></span>
<span></span>
<span><span class="va">multifold.results.poisson2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span> <span class="va">multifold.results.poisson</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">multifold.results.poisson.group</span> <span class="op">&lt;-</span> <span class="va">multifold.results.poisson2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">multifold.results.poisson.group</span>  <span class="op">&lt;-</span> <span class="va">multifold.results.poisson.group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pPoissonMulti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">multifold.results.poisson.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Poisson; many repeated splits"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="poisson-many-folds-9">Poisson Many folds 9<a class="anchor" aria-label="anchor" href="#poisson-many-folds-9"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.poisson9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">nSplits</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">trial</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonManySplits9</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonManySplits9</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat.train</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span> </span>
<span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">raw.counts.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"counts"</span><span class="op">)</span></span>
<span><span class="va">sizeFacs.test</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span><span class="va">dat.test</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># calculcate within-cluster sse for each resolution</span></span>
<span><span class="va">clusters.full</span> <span class="op">&lt;-</span> <span class="va">pbmc</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="st">"RNA_snn_res.0.5"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">all.results.poisson9</span><span class="op">[</span><span class="va">trial</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.poisson9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">all.results.poisson9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">all.results.poisson9</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all.results.poisson9</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span><span class="va">all.results.poisson9</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span></span>
<span><span class="va">all.results.poisson92</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">all.results.poisson9</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">all.results.poisson9.group</span> <span class="op">&lt;-</span> <span class="va">all.results.poisson92</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">all.results.poisson9.group</span>  <span class="op">&lt;-</span> <span class="va">all.results.poisson9.group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pPoissonRepeated9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all.results.poisson9.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Poisson; many repeated splits, eps.train=0.9"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="many-nb-splits">Many nb Splits<a class="anchor" aria-label="anchor" href="#many-nb-splits"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">nSplits</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">trial</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbManySplits</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbManySplits</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># calculcate within-cluster sse for each resolution</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">all.results.nb</span><span class="op">[</span><span class="va">trial</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">all.results.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">all.results.nb</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">all.results.nb</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all.results.nb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span><span class="va">all.results.nb</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span></span>
<span><span class="va">all.results.nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">all.results.nb</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">all.results.nb.group</span> <span class="op">&lt;-</span> <span class="va">all.results.nb2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.results.nb.group</span>  <span class="op">&lt;-</span> <span class="va">all.results.nb.group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pnbRepeated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all.results.nb.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"nb; many repeated splits"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="nb-multifold">nb multifold<a class="anchor" aria-label="anchor" href="#nb-multifold"></a>
</h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">multifold.results.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">folds</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">multifold.results.nb.other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">folds</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">fold</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">folds</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xtest</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nb10folds</span><span class="op">[[</span><span class="va">fold</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="va">pbmc.counts</span> <span class="op">-</span> <span class="va">Xtest</span></span>
<span></span>
<span>  <span class="co">### The one was on purpose :). </span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">eps.train</span> <span class="op">&lt;-</span> <span class="fl">9</span><span class="op">/</span><span class="fl">10</span></span>
<span>  <span class="va">eps.test</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span></span>
<span></span>
<span>  <span class="va">raw.counts.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"counts"</span><span class="op">)</span></span>
<span>  <span class="va">sizeFacs.train</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span><span class="co"># default.dat.train &lt;- GetAssayData(pbmcTrain, layer="data")</span></span>
<span><span class="co"># my.dat.train &lt;- sapply(1:NCOL(raw.counts.train), </span></span>
<span><span class="co">#                              function(u) log1p(raw.counts.train[,u]/sizeFacs.train[u]*10000))</span></span>
<span><span class="co"># all.equal(as.numeric(default.dat.train), as.numeric(my.dat.train))</span></span>
<span>  <span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="co">#GetAssayData(pbmcTrain, layer="data")</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">raw.counts.train</span><span class="op">)</span>, </span>
<span>                             <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="op">(</span><span class="va">raw.counts.train</span><span class="op">[</span>,<span class="va">u</span><span class="op">]</span><span class="op">/</span><span class="va">eps.train</span><span class="op">)</span><span class="op">/</span><span class="va">sizeFacs.train</span><span class="op">[</span><span class="va">u</span><span class="op">]</span><span class="op">*</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dat.train2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw.counts.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"counts"</span><span class="op">)</span></span>
<span><span class="va">sizeFacs.test</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span><span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">raw.counts.test</span><span class="op">)</span>, </span>
<span>                           <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="op">(</span><span class="va">raw.counts.test</span><span class="op">[</span>,<span class="va">u</span><span class="op">]</span><span class="op">/</span><span class="va">eps.test</span><span class="op">)</span><span class="op">/</span><span class="va">sizeFacs.test</span><span class="op">[</span><span class="va">u</span><span class="op">]</span><span class="op">*</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat.test2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat.test2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span>  <span class="co"># calculcate within-cluster sse for each resolution</span></span>
<span> </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">multifold.results.nb</span><span class="op">[</span><span class="va">fold</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.test</span><span class="op">)</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>  <span class="va">multifold.results.nb.other</span><span class="op">[</span><span class="va">fold</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.train2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dat.test2</span><span class="op">)</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">multifold.results.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">multifold.results.nb.other</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">multifold.results.nb</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">multifold.results.nb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span><span class="va">multifold.results.nb</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">folds</span></span>
<span><span class="va">multifold.results.nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span> <span class="va">multifold.results.nb</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">multifold.results.nb.group</span> <span class="op">&lt;-</span> <span class="va">multifold.results.nb2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">multifold.results.nb.group</span>  <span class="op">&lt;-</span> <span class="va">multifold.results.nb.group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pnbMulti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">multifold.results.nb.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"nb; many repeated splits"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="nb-many-folds-9">nb Many folds 9<a class="anchor" aria-label="anchor" href="#nb-many-folds-9"></a>
</h4>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all.results.nb9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow<span class="op">=</span><span class="va">nSplits</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">trial</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  <span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbManySplits9</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nbManySplits9</span><span class="op">[[</span><span class="va">trial</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># same genes and cells in the train set as in the test set</span></span>
<span>  <span class="va">rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmcTrain</span><span class="op">)</span></span>
<span>  <span class="va">XtestSubset</span> <span class="op">&lt;-</span> <span class="va">Xtest</span><span class="op">[</span><span class="va">rows</span>,<span class="va">cols</span><span class="op">]</span></span>
<span>  <span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">XtestSubset</span>, min.cells<span class="op">=</span><span class="fl">0</span>, min.features<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">#run Seurat pipeline</span></span>
<span>  <span class="va">pbmcTrain</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#raw.counts.train &lt;- GetAssayData(pbmcTrain, layer="counts")</span></span>
<span><span class="co">#sizeFacs.train &lt;- pbmcTrain$nCount_RNA</span></span>
<span><span class="va">dat.train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  <span class="co">#sapply(1:NCOL(raw.counts.train), </span></span>
<span>                         <span class="co">#    function(u) log1p((raw.counts.train[,u]/eps.train)/sizeFacs.train[u]*10000))</span></span>
<span></span>
<span><span class="va">pbmcTest</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat.train</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>verbose<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">raw.counts.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"counts"</span><span class="op">)</span></span>
<span><span class="va">sizeFacs.test</span> <span class="op">&lt;-</span> <span class="va">pbmcTest</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span><span class="va">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AssayData.html" class="external-link">GetAssayData</a></span><span class="op">(</span><span class="va">pbmcTest</span>, layer<span class="op">=</span><span class="st">"data"</span><span class="op">)</span></span>
<span>  <span class="co">#sapply(1:NCOL(raw.counts.test), </span></span>
<span>             <span class="co">#                function(u) log1p((raw.counts.test[,u]/(eps.test))/sizeFacs.test[u]*10000))</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">res</span> <span class="kw">in</span> <span class="va">resRange</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, resolution <span class="op">=</span> <span class="va">res</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># calculcate within-cluster sse for each resolution</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resNames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">clusters.est</span> <span class="op">&lt;-</span> <span class="va">pbmcTrain</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[[</span><span class="va">resNames</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">all.results.nb9</span><span class="op">[</span><span class="va">trial</span>, <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">within.cluster.sse</span><span class="op">(</span><span class="va">dat.train</span>, <span class="va">dat.test</span>, <span class="va">clusters.est</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">all.results.nb9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">all.results.nb9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meanRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">all.results.nb9</span><span class="op">)</span></span>
<span><span class="va">normMeanRes</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">meanRes</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanRes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all.results.nb9</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resRange</span></span>
<span><span class="va">all.results.nb9</span><span class="op">$</span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">nSplits</span></span>
<span><span class="va">all.results.nb92</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">all.results.nb9</span>, </span>
<span>                                cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.results.nb9.group</span> <span class="op">&lt;-</span> <span class="va">all.results.nb92</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normVal <span class="op">=</span> <span class="op">(</span><span class="va">value</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">all.results.nb9.group</span>  <span class="op">&lt;-</span> <span class="va">all.results.nb9.group</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>normMeanRes <span class="op">=</span> <span class="va">normMeanRes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pnbRepeated9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">all.results.nb9.group</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normVal</span>, group<span class="op">=</span><span class="va">trial</span>, col<span class="op">=</span><span class="st">"Individual Split"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">resolution</span>, y<span class="op">=</span><span class="va">normMeanRes</span>, col<span class="op">=</span><span class="st">"Averaged"</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Within-cluster SSE"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"nb; many repeated splits, eps.train=0.9"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="looking-at-the-overall-results">Looking at the overall results<a class="anchor" aria-label="anchor" href="#looking-at-the-overall-results"></a>
</h3>
<p>Here we can compare all of the methods.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#pPoissonOne + pnbOne+</span></span>
<span><span class="va">pPoissonRepeated</span><span class="op">+</span> <span class="va">pnbRepeated</span> <span class="op">+</span></span>
<span><span class="va">pPoissonMulti</span><span class="op">+</span> <span class="va">pnbMulti</span> <span class="op">+</span></span>
<span><span class="va">pPoissonRepeated9</span><span class="op">+</span> <span class="va">pnbRepeated9</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">3</span>, byrow<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Normalized SSE"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Resolution"</span>, breaks<span class="op">=</span><span class="va">resRange</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span>, by<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, labels<span class="op">=</span><span class="va">resRange</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span>, by<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, limit<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">8</span>, angle<span class="op">=</span><span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>        plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>l<span class="op">=</span><span class="fl">.3</span>, t<span class="op">=</span><span class="fl">0</span>, unit<span class="op">=</span><span class="st">"cm"</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>        axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="stability-based-analysis">Stability-based analysis<a class="anchor" aria-label="anchor" href="#stability-based-analysis"></a>
</h2>
<p>Reconstruction-based error like mean-squared error is not the only
way to evaluate the goodness of a clustering. Another metric that we
might want is stability. If we separately cluster the independent
training and test sets, do we get similar results? Let’s try it.</p>
<p>We can use the same countsplit objects that we made earlier in this
document.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rands.poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resRange</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Xtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonSplit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">Xtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">poissonSplit</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">Xtrain</span>, min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> </span>
<span><span class="va">pbmcTrain</span><span class="op">[[</span><span class="st">"percent.mt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html" class="external-link">PercentageFeatureSet</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span><span class="op">)</span> </span>
<span><span class="va">pbmcTrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pbmcTrain</span>, subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span> <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">2500</span> <span class="op">&amp;</span> <span class="va">percent.mt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> </span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!-- rows &lt;- rownames(pbmcTrain) --&gt;</span></span>
<span><span class="co"># &lt;!-- cols &lt;- colnames(pbmcTrain) --&gt;</span></span>
<span><span class="co"># &lt;!-- XtestSubset &lt;- Xtest[rows,cols] --&gt;</span></span>
<span><span class="co"># &lt;!-- pbmcTest &lt;- CreateSeuratObject(counts=XtestSubset, min.cells=0, min.features = 0) --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!-- #run Seurat pipeline --&gt;</span></span>
<span><span class="co"># &lt;!-- pbmcTrain &lt;- --&gt;</span></span>
<span><span class="co"># &lt;!--   pbmcTrain %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   NormalizeData(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   FindVariableFeatures(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   ScaleData(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   RunPCA(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   FindNeighbors(dims = 1:10,verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   RunUMAP(dims = 1:10,verbose=F) --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!-- pbmcTest &lt;- pbmcTest %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   NormalizeData(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   FindVariableFeatures(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   ScaleData(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   RunPCA(verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   FindNeighbors(dims = 1:10,verbose=F) %&gt;% --&gt;</span></span>
<span><span class="co"># &lt;!--   RunUMAP(dims = 1:10,verbose=F) --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!-- for (k in 1:length(resNames)) { --&gt;</span></span>
<span><span class="co"># &lt;!--   pbmcTrain &lt;- FindClusters(pbmcTrain, resolution = res, verbose=FALSE) --&gt;</span></span>
<span><span class="co"># &lt;!--   pbmcTest &lt;- FindClusters(pbmcTrain, resolution = res, verbose=FALSE) --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!--   clusters.est.train &lt;- pbmcTrain@meta.data[[resNames[k]]] --&gt;</span></span>
<span><span class="co"># &lt;!--   clusters.est.test  &lt;- pbmcTest@meta.data[[resNames[k]]] --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!--   rands.poisson[k] &lt;- mclust::adjustedRandIndex(clusters.est.train, clusters.est.test) --&gt;</span></span>
<span><span class="co"># &lt;!-- } --&gt;</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># &lt;!-- plot(rands.poisson) --&gt;</span></span></code></pre></div>
<!-- ### Many splits Poisson -->
<!-- ```{r} -->
<!-- rands.poisson.many <- rep(NA, length(resRange)) -->
<!-- Xtrain <- t(poissonSplit[[1]]) -->
<!-- Xtest <- t(poissonSplit[[2]]) -->
<!-- pbmcTrain <- CreateSeuratObject(counts = Xtrain, min.cells = 5, min.features = 200) -->
<!-- pbmcTrain[["percent.mt"]] <- PercentageFeatureSet(pbmcTrain, pattern = "^MT-") -->
<!-- pbmcTrain <- subset(pbmcTrain, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5) -->
<!-- # same genes and cells in the train set as in the test set -->
<!-- rows <- rownames(pbmcTrain) -->
<!-- cols <- colnames(pbmcTrain) -->
<!-- XtestSubset <- Xtest[rows,cols] -->
<!-- pbmcTest <- CreateSeuratObject(counts=XtestSubset, min.cells=0, min.features = 0) -->
<!-- #run Seurat pipeline -->
<!-- pbmcTrain <- -->
<!--   pbmcTrain %>% -->
<!--   NormalizeData(verbose=F) %>% -->
<!--   FindVariableFeatures(verbose=F) %>% -->
<!--   ScaleData(verbose=F) %>% -->
<!--   RunPCA(verbose=F) %>% -->
<!--   FindNeighbors(dims = 1:10,verbose=F) %>% -->
<!--   RunUMAP(dims = 1:10,verbose=F) -->
<!-- pbmcTest <- pbmcTest %>% -->
<!--   NormalizeData(verbose=F) %>% -->
<!--   FindVariableFeatures(verbose=F) %>% -->
<!--   ScaleData(verbose=F) %>% -->
<!--   RunPCA(verbose=F) %>% -->
<!--   FindNeighbors(dims = 1:10,verbose=F) %>% -->
<!--   RunUMAP(dims = 1:10,verbose=F) -->
<!-- for (k in 1:length(resNames)) { -->
<!--   pbmcTrain <- FindClusters(pbmcTrain, resolution = res, verbose=FALSE) -->
<!--   pbmcTest <- FindClusters(pbmcTrain, resolution = res, verbose=FALSE) -->
<!--   clusters.est.train <- pbmcTrain@meta.data[[resNames[k]]] -->
<!--   clusters.est.test  <- pbmcTest@meta.data[[resNames[k]]] -->
<!--   rands.poisson[k] <- mclust::adjustedRandIndex(clusters.est.train, clusters.est.test) -->
<!-- } -->
<!-- plot(rands.poisson) -->
<!-- ``` -->
</div>
<div class="section level2">
<h2 id="modularity-based-analysis">Modularity-based analysis<a class="anchor" aria-label="anchor" href="#modularity-based-analysis"></a>
</h2>
<p>The Louvain clustering algorithm optimizes clusters for a metric
called “modularity”. If we really believe that Louvain clustering is the
right one to use, we might wish to pick the clustering that optimizes
the modularity.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Anna Neufeld.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
